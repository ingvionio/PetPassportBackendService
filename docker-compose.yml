version: '3.8'

services:
  # 1. üêò PostgreSQL –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö
  postgres:
    image: postgres:16-alpine
    container_name: petpassport-db
    environment:
      POSTGRES_DB: PetPassportDb
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
    # –ü–æ—Ä—Ç 5433:5432 - –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –ò–ó–í–ù–ï. –í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –ø–æ—Ä—Ç –≤—Å–µ–≥–¥–∞ 5432.
    ports:
      - "5433:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - petpassport-network

  # 2. üñ•Ô∏è ASP.NET Core –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ (API)
  api:
    build:
      context: .  
      dockerfile: Dockerfile
    container_name: petpassport-api
    environment:
      # –•–æ—Å—Ç –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö - —ç—Ç–æ –∏–º—è —Å–µ—Ä–≤–∏—Å–∞: 'postgres'
      ConnectionStrings__DefaultConnection: "Host=postgres;Port=5432;Database=PetPassportDb;Username=postgres;Password=${POSTGRES_PASSWORD}"
      # –ê–¥—Ä–µ—Å –±–æ—Ç–∞ - —ç—Ç–æ –∏–º—è —Å–µ—Ä–≤–∏—Å–∞: 'telegram-bot'
      BotService__BaseUrl: "http://telegram-bot:8080" # <-- –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ –¥–ª—è –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–π —Å–≤—è–∑–∏ Docker
      ASPNETCORE_URLS: "http://0.0.0.0:8080"
      CORS_ORIGINS: "${CORS_ORIGINS}"
      ASPNETCORE_ENVIRONMENT: Production
    ports:
      - "80:8080" # –ü—É–±–ª–∏–∫—É–µ–º API –Ω–∞ –ø–æ—Ä—Ç 80 —Ö–æ—Å—Ç–∞ (—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π HTTP)
    depends_on:
      postgres:
        condition: service_healthy
    volumes:
      - ./uploads:/app/wwwroot/uploads
    networks:
      - petpassport-network

  # 3. ü§ñ Python Bot (Aiohttp)
  telegram-bot:
    build:
      context: ./PetPassport-TgBot  # <-- –ü—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º, —á—Ç–æ Python –ª–µ–∂–∏—Ç –≤ –ø–∞–ø–∫–µ 'bot-project'
      dockerfile: Dockerfile
    container_name: telegram-bot
    restart: unless-stopped
    # –ü–æ—Ä—Ç 8080:8080 - –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –ò–ó–í–ù–ï (–µ—Å–ª–∏ –≤—ã –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ webhook).
    # –ï—Å–ª–∏ –±–æ—Ç –∏—Å–ø–æ–ª—å–∑—É–µ—Ç Long Polling, —ç—Ç–æ—Ç –ø–æ—Ä—Ç –Ω–µ –Ω—É–∂–µ–Ω.
    ports:
      - "8081:8080" # –ú–µ–Ω—è–µ–º –ø–æ—Ä—Ç, —á—Ç–æ–±—ã –Ω–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤–∞–ª —Å API (8080)
    environment:
      - BOT_TOKEN=${BOT_TOKEN}
      - HTTP_HOST=0.0.0.0
      - HTTP_PORT=8080
      # –ê–¥—Ä–µ—Å –±—ç–∫–µ–Ω–¥–∞ - —ç—Ç–æ –∏–º—è —Å–µ—Ä–≤–∏—Å–∞: 'api'
      - BASE_URL=http://api:8080 # <-- –ò–º—è —Å–µ—Ä–≤–∏—Å–∞ API –∏ –µ–≥–æ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –ø–æ—Ä—Ç
    volumes:
      - ./img:/app/img
    networks:
      - petpassport-network

volumes:
  postgres_data:

networks:
  petpassport-network:
    driver: bridge